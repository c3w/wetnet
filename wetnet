#!/usr/bin/env python

import sys, os, iplib, MySQLdb


db=MySQLdb.connect (user="wetnet",
                    passwd="wetnet123",
                    db="wetnet")

def usage(argv):
 if len(argv) == 1:
  print 'Usage: wetnet [create|query] [organization|supernet|route|set|subnet|host] [route|orgname|x.x.x.x/x] [/xx] [route]'
  sys.exit(0)

usage(sys.argv)
sys.argv.pop(0)
cmd=str(sys.argv[0])

def create_organization():
 print "create_organization"
 usage(sys.argv)
 sys.argv.pop(0)
 org=str(sys.argv[0])
 key=raw_input("Create Organization " + org + "? [Y/n]")
 if key == "Y":
  print "YES!"
  cursor = db.cursor ()
  Q="INSERT into organizations (organization_name) VALUES ('" + org + "');"
  cursor.execute (Q)
  cursor.execute ("commit")
  cursor.close ()

def create_supernet():
 print "create_supernet"
 usage(sys.argv)
 sys.argv.pop(0)
 supernet=str(sys.argv[0])
 usage(sys.argv)
 organization=str(sys.argv[1])
 print("supernet is %s and org is %s" % (supernet, organization))
 try:
  cidr = iplib.CIDR(supernet)
 except ValueError:
  sys.stderr.write('%s: invalid CIDR address.\n' % supernet)
 try:
  cursor = db.cursor ()
  Q="INSERT into supernets (supernet, organization) VALUES ('" + supernet+ "','" + organization + "');"
  print("[INSERT SUPERNET] %s" % supernet)
  cursor.execute (Q)
  cursor.execute ("commit")
  cursor.close ()
 except MySQLdb.IntegrityError:
  print("DUPLICATE SuperNet %s - exiting" % supernet)
  sys.exit(3)
 print str(cidr.network_ip)
 networkArray = str.split(str(cidr.network_ip),'.')
 print networkArray
 print str(cidr.netmask)
 supernetArray = str.split(supernet, '/')
 if int(supernetArray[1]) > 24:
  print "minumum supernet is /24"
  sys.exit(3)
 print str(cidr.broadcast_ip)
 broadcastArray = str.split(str(cidr.broadcast_ip),'.')
 print broadcastArray
 print str(cidr.first_ip)
 print str(cidr.last_ip)
 for d in range(int(networkArray[2]), int(broadcastArray[2])+1):
  set=str("%s.%s.%s.0/24" % (networkArray[0], networkArray[1], str(d)))
  cursor = db.cursor ()
  Q="INSERT into `sets` (`set`, `supernet`) VALUES ('" + set + "','" + supernet + "');"
  print("[INSERT SET from SUPERNET %s] %s" % (supernet, set))
  try:
   cursor.execute (Q)
   cursor.execute ("commit")
   cursor.close ()
  except MySQLdb.IntegrityError:
   print ("DUPLICATE SET %s -- exiting" % set)
   sys.exit(3)
 

def create_set():
 print "create_set"
 usage(sys.argv)
 sys.argv.pop(0)
 usage(sys.argv)
 set=str(sys.argv[0])
 sub=str(sys.argv[1])
 sys.argv.pop(0)
 usage(sys.argv)
 route=str(sys.argv[1])
 print("set is %s and sub is %s and route is %s" % (set, sub, route))
 try:
  cidr = iplib.CIDR(set)
 except ValueError:
  sys.stderr.write('%s: invalid CIDR address.\n' % set)
  sys.exit(3)
 networkArray = str.split(str(cidr.network_ip),'.')
 subArray = str.split(sub, '/')
 stepSize = 2**(32-int(subArray[1]))
 try:
  cursor = db.cursor ()
  Q=str("UPDATE `sets` SET `subnet_as` = '%s', `route`='%s' WHERE `set` LIKE '%s/24'" % (sub, route, str(cidr.network_ip)))
  print Q
  print("[MODIFY SET] %s subnet as %s routed via %s" % (set, sub, route))
  cursor.execute (Q)
  cursor.execute ("commit")
  cursor.close ()
 except MySQLdb.IntegrityError:
  print("DUPLICATE SuperNet %s - exiting" % supernet)
 for i in range(int(networkArray[3]), 256, stepSize):
  currentSubnet = str("%s.%s.%s.%s/%s" % (networkArray[0],networkArray[1],networkArray[2],i,subArray[1]))
  try:
   cursor = db.cursor ()
   Q="INSERT into `subnets` (`subnet`, `set`) VALUES ('" + currentSubnet + "','" + set + "');"
   print("[INSERT SUBNET from SET %s] %s" % (set, currentSubnet))
   cursor.execute (Q)
   cursor.execute ("commit")
   cursor.close ()
  except MySQLdb.IntegrityError:
   print("DUPLICATE SubNET %s - exiting" % currentSubnet)

def create_subnet():
 print "create_subnet"
 usage(sys.argv)
 sys.argv.pop(0)
 subnet=sys.argv[0]
 usage(sys.argv)
 identifier=sys.argv[1] 
 Q=str("UPDATE subnets SET `identifier` = '%s' WHERE `subnet` LIKE '%s'" % (identifier, subnet))
 print("[UPDATE SUBNET %s IDENTIFIER %s]" % (subnet, identifier))
 cursor = db.cursor ()
 cursor.execute (Q)
 cursor.execute ("commit")
 cursor.close ()


def create_host():
 print "create_host"

def query_organization():
 print "query_organization"

def query_supernet():
 print "query_supernet"
 cursor = db.cursor ()
 cursor.execute ("SELECT VERSION()")
 row = cursor.fetchone ()
 print "server version:", row[0]
 cursor.close ()

def query_set():
 print "query_set"

def query_subnet():
 print "query_subnet"

def query_host():
 print "query_host"

def query():
 usage(sys.argv) 
 sys.argv.pop(0)
 print "you are querying " + sys.argv[0]
 options = {"organization" : query_organization,
            "supernet" : query_supernet,
            "set" : query_set,
            "subnet" : query_subnet,
            "host" : query_host
 }
 options[sys.argv[0]]()

def create():
 usage(sys.argv) 
 sys.argv.pop(0)
 print "you are creating"
 options = {"organization" : create_organization,
            "supernet" : create_supernet,
            "set" : create_set,
            "subnet" : create_subnet,
            "host" : create_host
 }
 options[sys.argv[0]]()

options = {"query" : query,
           "create" : create
}
options[cmd]()

